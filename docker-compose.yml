version: '3'

volumes:
  pg-db-data:
    driver: local
  pg-admin-data:
    driver: local

networks: 
  pg-network:
    driver: bridge

services:
    app:
        hostname: app
        image: pycommerce
        build:
          context: .
          dockerfile: Dockerfile
        environment:
            ENV: "dev"
            LOG_LEVEL: "debug"
            DB_URL: "postgresql+asyncpg://postgres:passwd@pgsql-db:5432/pycommerce_dev"
            SERVER_RELOAD: false
        command: /bin/sh -c "alembic upgrade head && python -m pycommerce"
        ports:
          - "8080:8080"
        depends_on:
          - pg-db
        networks:
          - pg-network

    # lint:
    #     <<: *base
    #     command: /bin/sh -c "pip install flake8 && flake8 pycommerce/ tests/"
        
    # type-check:
    #     <<: *base
    #     command: /bin/sh -c "pip install mypy && mypy pycommerce/ tests/"

    # unit-test:
    #     <<: *base
    #     command: /bin/sh -c "pip install pytest && pytest tests/unit"
    #     environment:
    #       ENV: "test"
    
    # integration-test:
    #     <<: *base
    #     command: /bin/sh -c "pip install pytest && pytest tests/integration"
    #     environment:
    #       <<: *env
    #       ENV: "test"
    #       DB_URL: "postgresql+asyncpg://postgres:passwd@pgsql-db:5432/pycommerce_test"
    #     depends_on:
    #       - pg-db
    #     networks:
    #       - pg-network

    pg-db:
        hostname: pg-db
        image: postgres:15.2-alpine
        environment:
          POSTGRES_PASSWORD: "passwd"
        ports:
          - "5432:5432"
        volumes:
          - ./scripts/pg:/docker-entrypoint-initdb.d
          - pg-db-data:/var/lib/postgresql/data
        networks:
          - pg-network

    pg-admin:
        hostname: pg-admin
        image: dpage/pgadmin4
        environment:
          PGADMIN_DEFAULT_EMAIL: "local@dev.com"
          PGADMIN_DEFAULT_PASSWORD: "passwd"
        ports:
          - "6001:80"
        volumes:
          - pg-admin-data:/var/lib/pgadmin
        depends_on:
          - pg-db
        networks:
          - pg-network
